<!DOCTYPE html>
<html>
<head>
    <title>Collective Memory</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .btn-delete { color: #e74c3c; cursor: pointer; background: none; border: none; font-weight: bold; padding: 0; }
        .btn-download { color: #27ae60; text-decoration: none; font-weight: bold; margin-right: 15px; }
        .btn-download:hover { text-decoration: underline; }
        .status-box { margin-top: 20px; padding: 15px; border-radius: 5px; display: none; }
        .train-section { background: #e8f4fd; padding: 20px; border-radius: 8px; border: 1px solid #3498db; margin-top: 30px; }
        
        .registry-section { background: #fffcf0; padding: 20px; border-radius: 8px; border: 1px solid #f1c40f; margin-top: 30px; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; border: 1px solid #ccc; }
        .badge-prod { background: #27ae60; color: white; border-color: #1e8449; }
        .btn-promote { background: #f1c40f; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: bold; }
        .btn-promote:hover { background: #d4ac0d; }
    </style>
</head>
<body>
    <a href="/" style="text-decoration: none;">‚Üê Back to Trainer</a>
    <h1>Cloud Data Archive</h1>
    <p>These files are stored in GCS and used for the next training cycle.</p>

    <table>
        <thead>
            <tr>
                <th>File Name</th>
                <th>Size</th>
                <th>Last Modified</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
            <tr>
                <td>{{ file.name }}</td>
                <td>{{ (file.size|int / 1024) | round(2) }} KB</td>
                <td>{{ file.time }}</td>
                <td>
                    <a href="{{ url_for('download_file', filename=file.name) }}" class="btn-download">Download</a>
                    <form action="/delete/{{ file.name }}" method="post" style="display:inline;">
                        <button type="submit" class="btn-delete" onclick="return confirm('Delete this file from GCS?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="train-section">
        <h3>Model Intelligence</h3>
        <p>Trigger a new training run using all files listed above.</p>
        <button id="trainBtn" onclick="triggerTraining()" style="background: #27ae60; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer;">
            üöÄ Retrain Model on All Cloud Data
        </button>
        <div id="trainStatus" class="status-box"></div>
    </div>

    <div class="registry-section">
        <h3>Model Registry (MLflow)</h3>
        <p>Manage model lifecycle versions and deployment stages.</p>
        <table>
            <thead>
                <tr>
                    <th>Version</th>
                    <th>Accuracy</th>
                    <th>Stage</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% if model_versions %}
                    {% for m in model_versions %}
                    <tr>
                        <td><strong>v{{ m.version }}</strong></td>
                        <td>{{ m.accuracy }}</td>
                        <td>
                            <span class="badge {{ 'badge-prod' if m.stage == 'Production' else '' }}">
                                {{ m.stage }}
                            </span>
                        </td>
                        <td>
                            {% if m.stage != "Production" %}
                                <button class="btn-promote" onclick="promoteToProd('{{ m.version }}')">üöÄ Promote to Production</button>
                            {% else %}
                                <span style="color: #27ae60; font-weight: bold;">‚óè Active</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="4" style="text-align: center;">No models registered yet.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <script>
        function triggerTraining() {
            const btn = document.getElementById('trainBtn');
            const status = document.getElementById('trainStatus');
            btn.disabled = true;
            status.style.display = 'block';
            status.style.background = '#d1ecf1';
            status.innerText = "Training started... (Refreshing in 5s)";
            fetch('/trigger-train', { method: 'POST' })
                .then(res => res.json())
                .then(() => {
                    status.style.background = '#d4edda';
                    status.innerText = "Success! Reloading...";
                    setTimeout(() => location.reload(), 5000);
                });
        }

        function promoteToProd(version) {
            if(!confirm("Are you sure you want to promote v" + version + " to Production?")) return;
            fetch('/promote/' + version, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                });
        }
    </script>
    <div class="form-section">
        <h3>Training Terminal</h3>
        <pre id="log-window" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px;">
            Loading logs...
        </pre>
    </div>

    <script>
        function fetchLogs() {
            fetch('/logs')
                .then(response => response.text())
                .then(data => {
                    const logWindow = document.getElementById('log-window');
                    logWindow.textContent = data;
                    logWindow.scrollTop = logWindow.scrollHeight; // Auto-scroll to bottom
                });
        }
        // Refresh logs every 3 seconds
        setInterval(fetchLogs, 3000);
        fetchLogs(); // Initial load
    </script>
</body>
</html>