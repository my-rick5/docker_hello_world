<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collective Memory - Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .card { margin-bottom: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .terminal {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-bar { padding: 10px; border-radius: 5px; margin-top: 10px; font-weight: bold; }
        .btn-retrain { background-color: #00a86b; color: white; border: none; }
        .btn-retrain:hover { background-color: #008f5d; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="mb-4"># Cloud Data Archive</h1>
    <p>These files are stored in GCS and used for the next training cycle.</p>

    <div class="card p-3">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>File Name</th>
                    <th>Size</th>
                    <th>Last Modified</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                <tr>
                    <td>{{ file.name }}</td>
                    <td>{{ file.size }}</td>
                    <td>{{ file.time }}</td>
                    <td>
                        <a href="/download/{{ file.name }}" class="text-success text-decoration-none fw-bold">Download</a>
                        <span class="text-danger ms-2" style="cursor:pointer;">Delete</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card p-4" style="border: 2px solid #add8e6;">
        <h3>Model Intelligence</h3>
        <p>Trigger a new training run using all files listed above.</p>
        
        <form action="/trigger-train" method="POST">
            <button type="submit" class="btn btn-retrain">
                ðŸš€ Retrain Model on All Cloud Data
            </button>
        </form>

        <div id="training-status" class="status-bar bg-info-subtle text-info-emphasis mt-3" style="display:none;">
            Training started... (Logs updating in real-time)
        </div>
    </div>

    <div class="card p-4" style="border: 2px solid #fff3cd;">
        <h3>Model Registry (MLflow)</h3>
        <p>Manage model lifecycle versions and deployment stages.</p>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Version</th>
                    <th>Accuracy</th>
                    <th>Stage</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% if model_versions %}
                    {% for m in model_versions %}
                    <tr>
                        <td>{{ m.version }}</td>
                        <td>{{ m.accuracy }}</td>
                        <td><span class="badge bg-secondary">{{ m.stage }}</span></td>
                        <td>
                            <form action="/promote/{{ m.version }}" method="POST" style="display:inline;">
                                <button class="btn btn-sm btn-outline-primary">Promote to Prod</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="4" class="text-center text-muted">No models registered yet.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <h3>Training Terminal</h3>
    <div id="log-terminal" class="terminal">No logs yet. Click 'Retrain' to start.</div>
</div>

<script>
    // 1. Show status bar when form is submitted
    document.querySelector('form[action="/trigger-train"]').onsubmit = function() {
        document.getElementById('training-status').style.display = 'block';
    };

    // 2. Poll /logs endpoint every 2 seconds
    function fetchLogs() {
        fetch('/logs')
            .then(response => response.text())
            .then(data => {
                const terminal = document.getElementById('log-terminal');
                
                // Only update and scroll if there is new content
                if (data.trim() !== "" && data !== terminal.innerText) {
                    terminal.innerText = data;
                    terminal.scrollTop = terminal.scrollHeight; // Auto-scroll
                }
            })
            .catch(err => console.error("Log fetch error:", err));
    }

    // Start polling
    setInterval(fetchLogs, 2000);
    
    // Initial fetch on load
    window.onload = fetchLogs;
</script>

</body>
</html>